name: Sync CTF Writeups
on:
  push:
    branches: [ "main" ]
    paths:
      - "ctf/**"
  schedule:
    - cron: "0 2 * * *"   # Daily sync
  workflow_dispatch:
jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    # Checkout your website repo (akapaldo.github.io)
    - name: Checkout website repo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: true
        submodules: false
    # Checkout CTF repo
    - name: Checkout CTF repo
      uses: actions/checkout@v4
      with:
        repository: AKapaldo/CTF-Writeups
        path: ctf-src
    - name: Sync all writeups
      run: |
        mkdir -p _posts/ctf
        find ctf-src -type f -iname "readme.md" | while read FILE; do
          # Get the number of slashes in the path relative to ctf-src
          RELATIVE_PATH="${FILE#ctf-src/}"
          SLASH_COUNT=$(echo "$RELATIVE_PATH" | awk -F"/" '{print NF-1}')
        
          # Only process if it's in a subfolder (competition/challenge/readme.md)
          if [ "$SLASH_COUNT" -eq 2 ]; then
              COMPETITION=$(echo "$RELATIVE_PATH" | cut -d'/' -f1)
              CHALLENGE=$(echo "$RELATIVE_PATH" | cut -d'/' -f2)
        
              DATE=$(git -C ctf-src log -1 --format="%ad" --date=short -- "$FILE")
              OUT="_posts/ctf/${DATE}-${COMPETITION}-${CHALLENGE}.md"
        
              # Clean up competition name for category (remove spaces, special chars)
              COMPETITION_CATEGORY=$(echo "$COMPETITION" | sed 's/ /_/g' | sed 's/[^a-zA-Z0-9_-]//g')
              
              # Clean up challenge name for title (replace underscores with spaces)
              CHALLENGE_TITLE=$(echo "$CHALLENGE" | sed 's/_/ /g')
        
              {
                echo "---"
                echo "title: \"${CHALLENGE_TITLE}\""
                echo "date: ${DATE}"
                echo "categories:"
                echo "  - ${COMPETITION_CATEGORY}"
                echo "tags:"
                echo "  - CTF"
                echo "platform: ${COMPETITION}"
                echo "toc: true"
                echo "toc_sticky: true"
                echo "---"
                echo
                cat "$FILE"
              } > "$OUT"
          fi
        done
    - name: Commit and push changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add .
        git commit -m "Auto-sync CTF writeups" || echo "No changes to commit"
        git push
