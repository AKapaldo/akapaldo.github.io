name: Sync CTF Writeups
on:
  push:
    branches: [ "main" ]
    paths:
      - "ctf/**"
  schedule:
    - cron: "0 2 * * *"   # Daily sync
  workflow_dispatch:
jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    # Checkout your website repo (akapaldo.github.io)
    - name: Checkout website repo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: true
        submodules: false
    # Checkout CTF repo with full history to get creation dates
    - name: Checkout CTF repo
      uses: actions/checkout@v4
      with:
        repository: AKapaldo/CTF-Writeups
        path: ctf-src
        fetch-depth: 0  # Get full git history
    - name: Sync all writeups
      run: |
        mkdir -p _posts/ctf
        
        cd ctf-src
        
        find . -type f -iname "readme.md" | while read FILE; do
          # Get the number of slashes in the path relative to current dir
          RELATIVE_PATH="${FILE#./}"
          SLASH_COUNT=$(echo "$RELATIVE_PATH" | awk -F"/" '{print NF-1}')
        
          # Only process if it's in a subfolder (competition/challenge/readme.md)
          if [ "$SLASH_COUNT" -eq 2 ]; then
              COMPETITION=$(echo "$RELATIVE_PATH" | cut -d'/' -f1)
              CHALLENGE=$(echo "$RELATIVE_PATH" | cut -d'/' -f2)
        
              # Get the date when this file was first added to git
              FILE_DATE=$(git log --follow --format=%ad --date=short --diff-filter=A -- "$FILE" | tail -1)
              if [ -z "$FILE_DATE" ]; then
                FILE_DATE=$(date +"%Y-%m-%d")
              fi
              
              # Check if this post already exists with ANY date
              cd ..
              EXISTING_POST=$(find _posts/ctf -name "*-${COMPETITION}-${CHALLENGE}.md" 2>/dev/null | head -1)
              
              if [ -n "$EXISTING_POST" ]; then
                # Post exists, use its existing filename
                OUT="$EXISTING_POST"
              else
                # New post, create with git creation date
                OUT="_posts/ctf/${FILE_DATE}-${COMPETITION}-${CHALLENGE}.md"
              fi
              
              cd ctf-src
        
              # Extract category from the markdown table
              CHALLENGE_TYPE=$(grep -m 1 "^|[ğŸğŸ“¦ğŸ”ğŸŒâš’ï¸ğŸ•µï¸ğŸ”]" "$FILE" | sed 's/|//g' | sed 's/^[ğŸğŸ“¦ğŸ”ğŸŒâš’ï¸ğŸ•µï¸ğŸ” ]*//' | awk '{print $1}' | xargs)
              
              # If no category found, default to "CTF"
              if [ -z "$CHALLENGE_TYPE" ]; then
                CHALLENGE_TYPE="CTF"
              fi
              
              # Clean up competition name for category
              COMPETITION_CLEAN=$(echo "$COMPETITION" | sed 's/_/ /g')
              COMPETITION_CATEGORY=$(echo "$COMPETITION" | sed 's/[^a-zA-Z0-9_-]//g')
              
              # Extract year from competition name if present
              YEAR=$(echo "$COMPETITION" | grep -oE '[0-9]{4}' || echo "")
              
              # Clean up challenge name for title
              CHALLENGE_TITLE=$(echo "$CHALLENGE" | sed 's/_/ /g')

              # Extract Problem Type tags (handle Windows line endings)
              PROBLEM_TYPES=$(tr -d '\r' < "$FILE" | awk '/^## Problem Type/,/^## Solve/ {if (/^[-*] /) {sub(/^[-*] /, ""); print}}')
        
              {
                echo "---"
                echo "title: \"${CHALLENGE_TITLE}\""
                echo "date: ${FILE_DATE}"
                echo "categories:"
                echo "  - ${COMPETITION_CATEGORY}"
                echo "tags:"
                echo "  - \"${CHALLENGE_TYPE}\""
                if [ -n "$YEAR" ]; then
                  echo "  - \"${YEAR}\""
                fi
                # Add Problem Type tags if found
                if [ -n "$PROBLEM_TYPES" ]; then
                  echo "$PROBLEM_TYPES" | while read -r tag; do
                    if [ -n "$tag" ]; then
                      echo "  - \"${tag}\""
                    fi
                  done
                fi
                echo "platform: ${COMPETITION_CLEAN}"
                if [ -n "$YEAR" ]; then
                  echo "competition_year: ${YEAR}"
                fi
                echo "toc: true"
                echo "toc_sticky: true"
                echo "---"
                echo
                
                # Convert GitHub alerts to Minimal Mistakes notices
                tr -d '\r' < "$FILE" | sed '
                  # Convert [!NOTE] to notice--primary
                  s/^\[!NOTE\]/{: .notice--primary}\n**â„¹ï¸ NOTE:**/g
                  
                  # Convert [!CAUTION] to notice--warning
                  s/^\[!CAUTION\]/{: .notice--warning}\n**âš ï¸ CAUTION:**/g
                  
                  # Convert [!WARNING] to notice--danger
                  s/^\[!WARNING\]/{: .notice--danger}\n**âš ï¸ WARNING:**/g
                  
                  # Convert [!IMPORTANT] to notice--danger
                  s/^\[!IMPORTANT\]/{: .notice--danger}\n**â— IMPORTANT:**/g
                  
                  # Convert [!TIP] to notice--info
                  s/^\[!TIP\]/{: .notice--info}\n**ğŸ’¡ TIP:**/g
                '
              } > "../${OUT}"
          fi
        done
        
        cd ..
    - name: Commit and push changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add .
        git commit -m "Auto-sync CTF writeups" || echo "No changes to commit"
        git push
